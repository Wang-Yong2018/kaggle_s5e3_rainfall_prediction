---
title: "islr methods - classification rainfall"
author: "WY"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## librar y & load_data

### library

```{r}
library(tidyverse)
library(tidymodels)
library(finetune)
library(future)
library(purrr)
library(furrr)
library(textrecipes)
library(themis)
library(corrr)

library(bonsai)
library(lightgbm)
library(xgboost)
library(ranger)

library(readr)
library(janitor)
library(lubridate)
library(ISLR2)
library(ISLR)
```

### loading data

```{r}
data_path <- '../input/playground-series-s5e3/'
train<- 
  readr::read_csv(file.path(data_path, 'train.csv'),
                  show_col_types = FALSE)|>
  mutate(rainfall=as.factor(rainfall))
test <- 
  readr::read_csv(file.path(data_path, 'test.csv'),
                  show_col_types = FALSE)
submission <-  readr::read_csv(file.path(data_path, 'sample_submission.csv'),show_col_types = FALSE)
```
  
#### correlation EDA
```{r}
train |>select(-rainfall,-id,-day) |>correlate()|>network_plot()
test  |>select(-id,-day) |>correlate()|>network_plot()
```


```{r}
set.seed(1234)
df_split <- initial_split(train, prop = 0.8, strata = rainfall)
train_set <- training(df_split)
test_set <- testing(df_split)
cv_folds <- vfold_cv(train_set,
                     v = 10,
                     repeats = 1,
                     strata = rainfall)
```

## logistic Regression

```{r cache=FALSE}
lr_spec <- logistic_reg( )|>
  set_engine('glm')|>
  set_mode('classification')
```


```{r cache=FALSE}
lr_rcp_bs <- 
  recipe(rainfall ~ ., data = train_set) #|>
  #update_role(id, new_role='ID')|>
  #step_rm(date,year_offset)|>
  #step_impute_median(all_numeric_predictors())|> 
  #step_log(all_numeric_predictors(),offset = 1, skip = FALSE) |>
  # process the logical feature to factor feature
  #step_bin2factor(all_logical_predictors())|>
  # proceeding the convert the character feature to factorical feature
  #step_novel(all_nominal_predictors())|>
  #step_unknown(all_nominal_predictors()) |>
  #step_other(all_nominal_predictors())|>
  #step_dummy(all_nominal_predictors(),one_hot = TRUE) |>
  #step_nzv(all_predictors())|>
  #step_corr(all_numeric_predictors())|>
  #step_normalize(all_numeric_predictors())|> # Scale numeric predictors

  #check_missing(all_predictors())

v1_rcp<- lr_rcp_bs |>
  step_rm(id,day)|>
  #step_log(all_numeric_predictors(),offset=1)#|> # bad
  step_impute_median(all_numeric_predictors())|> 
  step_mutate(
   temp_range= maxtemp - mintemp,
   heat_index= temparature+ 0.5 * (temparature- 10) * (humidity / 100),
   dew_dep= temparature - dewpoint,
   #cloud_sun_ratio = cloud / sunshine + 1,    
   #pressure_change = c(NA, diff(pressure)),
   air_density = 1.225 , 
   wind_power = 0.5 * air_density * windspeed**3,
   wind_direction_cat = cut(winddirection, 
                            breaks=c(0, 90, 180, 270, 360), 
                            labels=c("North", "East", "South", "West"), 
                            include.lowest=TRUE),
   cloud_humidity = cloud + humidity,
   cloud_humidity_sunshine = cloud + humidity + sunshine,
   cloud_x_sunshine = cloud * sunshine,
   humidity_x_sunshine = humidity * sunshine)|>
   step_novel(all_nominal_predictors())|>
  step_unknown(all_nominal_predictors()) |>
  step_other(all_nominal_predictors())|>
  step_dummy(all_nominal_predictors(),one_hot = TRUE) |>
  step_nzv(all_predictors())|>
  step_normalize(all_numeric_predictors())|>
  step_corr(all_predictors())|>
  #step_smote(rainfall,over_ratio = 1,skip = TRUE)|> # bad 
  
  check_missing(all_predictors())
tmp_rcps <- list(bs=lr_rcp_bs,
                 v1=v1_rcp)
```


```{r cache=FALSE}
lr_w_fit <-
  workflow_set(preproc = tmp_rcps,
              models=list(glm=lr_spec))|>
  workflow_map(fn='fit_resamples',
               metrics=metric_set(roc_auc),
               resamples=cv_folds
               #,verbose=TRUE
               )
lr_w_fit |> collect_metrics()|>select(wflow_id,n, .metric, mean,std_err)
```

```{r}
train_set|>glimpse()

```

